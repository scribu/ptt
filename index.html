<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
<title>TT Settings</title>

<link href="./vendor/bootstrap-3.5.5/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

<div class="container">
	<form>
		<h3>Backend</h3>
		<div class="form-group">
			<label for="backend_url">URL</label>
			<input type="url" class="form-control" id="backend_url">
		</div>

		<div class="form-group">
			<label for="auth_key">Auth Key</label>
			<input type="password" class="form-control" id="auth_key">
		</div>

		<h3>Tasks</h3>

		<div id="tasks"></div>

		<div class="buttons form-group">
			<button id="save" type="submit" class="btn btn-primary">Save</button>
			<button id="add-task" class="btn btn-default pull-right">Add task</button>
		</div>
	</form>
</div>

<script type="text/html" id="task-template">
	<div class="task form-group">
		<div class="input-group">
			<input type="text" class="form-control" placeholder="Task name..." />
			<span class="input-group-btn">
				<button class="remove-task btn btn-danger">X</button>
			</span>
		</div><!-- /input-group -->
	</div>
</script>

<script type="text/javascript" src="./vendor/jquery-2.1.4.min.js"></script>
<script type="text/javascript">
jQuery(function($) {
	function getQueryParam(variable, default_) {
		var query = location.search.substring(1);
		var vars = query.split('&');
		for (var i = 0; i < vars.length; i++) {
			var pair = vars[i].split('=');
			if (pair[0] == variable)
				return decodeURIComponent(pair[1]);
		}
		return default_ || false;
	}

	var taskTemplate = $($('#task-template').text());

	function createTask(taskName) {
		var newTask = taskTemplate.clone();

		newTask.appendTo($('#tasks'));
		newTask.find('input').val(taskName);

		return newTask;
	}

	var rawOptions = getQueryParam('options', 'null');

	try {
		var options = JSON.parse(rawOptions) || {};
	} catch (e) {
		alert('Error reading existing options.');
		return;
	}

	if (options.tasks) {
		options.tasks.forEach(createTask);
	}

	if (options.backend_url) {
		$('#backend_url').val(options.backend_url);
	}

	$('form').on('click', '.remove-task', function() {
		$(this).closest('.task').remove();
	});

	$('#add-task').click(function(e) {
		e.preventDefault();

		var newTask = createTask('');
		newTask.find('input').focus();
	});

	$('form').on('keypress', 'input', function(e) {
		if (e.keyCode === 13) {
			// Odly enough, the default action is to remove the first field
			e.preventDefault();

			$('form').submit();
		}
	});

	function collectTasks() {
		var tasks = [];
		$('.task input').each(function() {
			var name = $(this).val();
			if (name !== '') {
				tasks.push(name);
			}
		});

		return tasks;
	}

	function collectBackendOptions() {
		return {
			'backend_url': $('#backend_url').val(),
			'auth_key': $('#auth_key').val(),
		}
	}

	$('form').submit(function(e) {
		e.preventDefault();

		var options = collectBackendOptions();
		options.tasks = collectTasks();

		var returnTo = getQueryParam('return_to', 'pebblejs://close#');
		var newUrl = returnTo + encodeURIComponent(JSON.stringify(options));

		document.location = newUrl;
	});
});
</script>
</body>
</html>
